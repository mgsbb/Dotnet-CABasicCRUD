services:
    api:
        image: cabasiccrud-postgresql-webapi
        build:
            context: ../..
            dockerfile: ./src/CABasicCRUD.Host.PostgreSql.WebApi/Dockerfile
            args:
                ConnectionStrings__DefaultConnection: ${ConnectionStrings__DefaultConnection}
        depends_on:
            migration-runner:
                condition: service_completed_successfully
        ports:
            - 5002:5002
        environment:
            ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
            ASPNETCORE_URLS: ${ASPNETCORE_URLS}
            OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT}
            Jwt__SecretKey: ${Jwt__SecretKey}
            Jwt__Issuer: ${Jwt__Issuer}
            Jwt__Audience: ${Jwt__Audience}
            Jwt__ExpiryInMinutes: ${Jwt__ExpiryInMinutes}
            ConnectionStrings__DefaultConnection: ${ConnectionStrings__DefaultConnection}
        volumes:
            - postgres_data:/var/lib/postgresql/data

    migration-runner:
        depends_on:
            postgres:
                condition: service_healthy
        image: cabasiccrud-postgresql-webapi
        working_dir: /myapp
        environment:
            ConnectionStrings__DefaultConnection: ${ConnectionStrings__DefaultConnection}
        entrypoint: ['./publish/efbundle']
        volumes:
            - postgres_data:/var/lib/postgresql/data

    postgres:
        image: postgres:18.1-alpine3.23
        restart: always
        environment:
            - POSTGRES_DB=${POSTGRES_DB}
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        ports:
            - 5432:5432
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U $POSTGRES_USER -d $POSTGRES_DB']
            interval: 5s
            timeout: 5s
            retries: 5
        volumes:
            - postgres_data:/var/lib/postgresql/data

    pgadmin:
        image: dpage/pgadmin4
        container_name: pgadmin
        environment:
            PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
            PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
        ports:
            - 5050:80
        depends_on:
            - postgres

    aspire-dashboard:
        image: mcr.microsoft.com/dotnet/aspire-dashboard:latest
        container_name: aspire-dashboard
        ports:
            - '127.0.0.1:18888:18888'
        restart: unless-stopped

volumes:
    postgres_data:
